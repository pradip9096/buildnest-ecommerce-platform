# Logstash configuration for centralized log ingestion (RQ-ES-ING-01, RQ-ES-ING-02, RQ-ES-ING-03)
# Handles both application logs and system events

input {
  # TCP input from application (JSON formatted logs)
  tcp {
    port => 5000
    codec => json
    type => "app-logs"
  }

  # HTTP input for webhook/API-based log submissions
  http {
    host => "0.0.0.0"
    port => 8081
    codec => json
    type => "api-logs"
  }
}

filter {
  # Parse JSON if not already parsed
  if [type] == "app-logs" or [type] == "api-logs" {
    # Extract timestamp and ensure proper format
    if [timestamp] {
      date {
        match => ["timestamp", "ISO8601"]
        target => "@timestamp"
      }
    }

    # Identify severity level for alerting (RQ-ES-ALRT-01)
    if [level] {
      if [level] =~ /ERROR|CRITICAL|FATAL/ {
        mutate {
          add_field => { "severity" => "CRITICAL" }
        }
      } else if [level] =~ /WARN/ {
        mutate {
          add_field => { "severity" => "WARN" }
        }
      } else {
        mutate {
          add_field => { "severity" => "INFO" }
        }
      }
    }

    # Add metadata tags for indexing
    mutate {
      add_field => { "environment" => "production" }
      add_field => { "version" => "1.0.0" }
    }

    # Remove null fields to reduce storage
    prune {
      whitelist_names => ["^[a-zA-Z]"]
    }
  }
}

output {
  # Send logs to Elasticsearch with daily index pattern (RQ-ES-ING-04)
  if [type] == "app-logs" or [type] == "api-logs" {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      user => "elastic"
      password => "changeme"
      index => "app-logs-%{+YYYY.MM.dd}"
      document_type => "_doc"
      ssl => false
    }
  }

  # Console output for debugging
  stdout {
    codec => json
  }
}
