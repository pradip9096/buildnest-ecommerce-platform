---
# BuildNest Production Secrets
# CRITICAL BLOCKER #1 FIX: Production Environment Variables Configuration
#
# IMPORTANT: This is a TEMPLATE file with placeholder values.
# DO NOT commit actual secrets to Git!
#
# Usage:
#   1. Copy this file: cp buildnest-secrets.yaml buildnest-secrets-prod.yaml
#   2. Replace all placeholder values with actual secrets
#   3. Apply to cluster: kubectl apply -f buildnest-secrets-prod.yaml
#   4. Add to .gitignore: echo "*-prod.yaml" >> .gitignore
#
# Secret Generation Commands:
#   JWT_SECRET:       openssl rand -base64 64
#   DB_PASSWORD:      openssl rand -base64 32
#   REDIS_PASSWORD:   openssl rand -base64 32
#   KEYSTORE_PASS:    openssl rand -base64 24
#   RAZORPAY_SECRET:  (Obtain from Razorpay dashboard)

apiVersion: v1
kind: Secret
metadata:
  name: buildnest-secrets
  namespace: buildnest
  labels:
    app: buildnest
    managed-by: manual
type: Opaque
stringData:
  # JWT Configuration (REQUIRED - No default value)
  # Generate: openssl rand -base64 64
  # Must be 512-bit minimum for security
  jwt.secret: "REPLACE_WITH_ACTUAL_JWT_SECRET_MINIMUM_64_CHARACTERS_BASE64_ENCODED"
  
  # Database Configuration (REQUIRED)
  # Generate: openssl rand -base64 32
  database.username: "buildnest_user"
  database.password: "REPLACE_WITH_ACTUAL_DATABASE_PASSWORD"
  
  # Redis Configuration (REQUIRED)
  # Generate: openssl rand -base64 32
  redis.password: "REPLACE_WITH_ACTUAL_REDIS_PASSWORD"
  
  # SSL/TLS Configuration (REQUIRED for HTTPS)
  # Generate keystore password: openssl rand -base64 24
  # Note: Keystore file itself is mounted separately as volume
  ssl.keystore.password: "REPLACE_WITH_ACTUAL_KEYSTORE_PASSWORD"
  
  # Payment Gateway Configuration (REQUIRED)
  # Obtain from Razorpay dashboard: https://dashboard.razorpay.com/app/keys
  razorpay.key.id: "REPLACE_WITH_RAZORPAY_KEY_ID"
  razorpay.key.secret: "REPLACE_WITH_RAZORPAY_KEY_SECRET"
  
  # OAuth2 Configuration (OPTIONAL - For social login)
  # Obtain from Google Cloud Console: https://console.cloud.google.com/apis/credentials
  google.client.id: "REPLACE_WITH_GOOGLE_CLIENT_ID_OR_LEAVE_EMPTY"
  google.client.secret: "REPLACE_WITH_GOOGLE_CLIENT_SECRET_OR_LEAVE_EMPTY"
  
  # Obtain from GitHub: https://github.com/settings/developers
  github.client.id: "REPLACE_WITH_GITHUB_CLIENT_ID_OR_LEAVE_EMPTY"
  github.client.secret: "REPLACE_WITH_GITHUB_CLIENT_SECRET_OR_LEAVE_EMPTY"

---
# BuildNest Configuration (Non-sensitive)
apiVersion: v1
kind: ConfigMap
metadata:
  name: buildnest-config
  namespace: buildnest
  labels:
    app: buildnest
data:
  # Database Configuration
  database.url: "jdbc:mysql://buildnest-mysql:3306/buildnest_ecommerce?useSSL=true&requireSSL=false"
  database.driver: "com.mysql.cj.jdbc.Driver"
  
  # Redis Configuration
  redis.host: "buildnest-redis"
  redis.port: "6379"
  redis.timeout: "3000"
  
  # Application Configuration
  spring.profiles.active: "production"
  server.port: "8080"
  
  # Cache TTL Configuration (in milliseconds)
  cache.ttl.products: "300000"       # 5 minutes
  cache.ttl.categories: "3600000"    # 1 hour
  cache.ttl.users: "1800000"         # 30 minutes
  cache.ttl.orders: "600000"         # 10 minutes
  
  # Rate Limiting Configuration
  rate.limit.login.requests: "5"
  rate.limit.login.duration: "300"
  rate.limit.product-search.requests: "100"
  rate.limit.product-search.duration: "60"
  rate.limit.admin.requests: "50"
  rate.limit.admin.duration: "60"
  rate.limit.user.requests: "500"
  rate.limit.user.duration: "60"

---
# Secret Creation Helper Script
# Save as: create-secrets.sh
# chmod +x create-secrets.sh && ./create-secrets.sh
#
# #!/bin/bash
# set -e
#
# echo "Generating BuildNest Production Secrets..."
#
# JWT_SECRET=$(openssl rand -base64 64 | tr -d '\n')
# DB_PASSWORD=$(openssl rand -base64 32 | tr -d '\n')
# REDIS_PASSWORD=$(openssl rand -base64 32 | tr -d '\n')
# KEYSTORE_PASSWORD=$(openssl rand -base64 24 | tr -d '\n')
#
# echo "Creating Kubernetes secret..."
# kubectl create secret generic buildnest-secrets \
#   --from-literal=jwt.secret="$JWT_SECRET" \
#   --from-literal=database.username="buildnest_user" \
#   --from-literal=database.password="$DB_PASSWORD" \
#   --from-literal=redis.password="$REDIS_PASSWORD" \
#   --from-literal=ssl.keystore.password="$KEYSTORE_PASSWORD" \
#   --from-literal=razorpay.key.id="$RAZORPAY_KEY_ID" \
#   --from-literal=razorpay.key.secret="$RAZORPAY_KEY_SECRET" \
#   --namespace=buildnest \
#   --dry-run=client -o yaml > buildnest-secrets-generated.yaml
#
# echo "✅ Secrets generated in buildnest-secrets-generated.yaml"
# echo "⚠️  IMPORTANT: Store these values securely!"
# echo "JWT_SECRET: $JWT_SECRET"
# echo "DB_PASSWORD: $DB_PASSWORD"
# echo "REDIS_PASSWORD: $REDIS_PASSWORD"
# echo "KEYSTORE_PASSWORD: $KEYSTORE_PASSWORD"

---
# Verification Checklist
# After applying secrets, verify with:
#
# 1. Check secret exists:
#    kubectl get secret buildnest-secrets -n buildnest
#
# 2. Verify keys are present:
#    kubectl describe secret buildnest-secrets -n buildnest
#
# 3. Test application startup:
#    kubectl logs -f deployment/buildnest-app -n buildnest
#    # Should NOT see: "JWT_SECRET environment variable is REQUIRED"
#
# 4. Verify JWT authentication works:
#    curl -X POST https://api.buildnest.com/api/auth/login \
#      -H "Content-Type: application/json" \
#      -d '{"username":"test","password":"test123"}'
