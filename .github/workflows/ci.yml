name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 1"

permissions:
  contents: read
  issues: write
  pull-requests: write
  checks: write

env:
  JAVA_VERSION: "21"

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: Validate Maven Wrapper
        run: chmod +x mvnw

      - name: Build with Maven
        run: ./mvnw -B clean package -DskipTests

      - name: Run Tests with JaCoCo Coverage
        run: ./mvnw -B clean test jacoco:report
        continue-on-error: false

      - name: Generate Coverage Report
        id: coverage
        if: always()
        run: |
          python - <<'PY'
          import xml.etree.ElementTree as ET
          import json
          from pathlib import Path
          
          report_file = Path("target/site/jacoco/jacoco.xml")
          if not report_file.exists():
              print("ERROR: JaCoCo report not found!")
              exit(1)
          
          tree = ET.parse(report_file)
          root = tree.getroot()
          
          # Extract counters
          counters = {}
          for counter in root.findall(".//counter"):
              counter_type = counter.get("type")
              missed = int(counter.get("missed", 0))
              covered = int(counter.get("covered", 0))
              total = missed + covered
              percentage = (covered / total * 100) if total > 0 else 0
              counters[counter_type] = {
                  "missed": missed,
                  "covered": covered,
                  "total": total,
                  "percentage": round(percentage, 2)
              }
          
          # Define thresholds
          thresholds = {
              "INSTRUCTION": 90.0,
              "LINE": 90.0,
              "BRANCH": 90.0,
              "METHOD": 90.0,
              "CLASS": 90.0
          }
          
          # Generate report
          report = "## üìä Code Coverage Report\n\n"
          report += "| Metric | Coverage | Threshold | Status |\n"
          report += "|--------|----------|-----------|--------|\n"
          
          all_pass = True
          for metric, threshold in thresholds.items():
              if metric in counters:
                  cov = counters[metric]
                  status = "‚úÖ" if cov["percentage"] >= threshold else "‚ùå"
                  if cov["percentage"] < threshold:
                      all_pass = False
                  report += f"| {metric} | {cov['percentage']}% | {threshold}% | {status} |\n"
          
          report += "\n### Detailed Metrics\n\n"
          for metric in ["INSTRUCTION", "LINE", "BRANCH", "METHOD", "CLASS"]:
              if metric in counters:
                  cov = counters[metric]
                  report += f"**{metric}**: {cov['covered']}/{cov['total']} = {cov['percentage']}%\n"
          
          # Write to summary
          Path("GITHUB_STEP_SUMMARY").write_text(report)
          
          # Export for next steps
          with open("coverage-results.json", "w") as f:
              json.dump(counters, f)
          
          print(report)
          if not all_pass:
              print("\n‚ö†Ô∏è  Some coverage thresholds not met!")
          PY

      - name: Comment PR with Coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage-results.json', 'utf8'));
            
            let comment = '## üìä Coverage Analysis\n\n';
            comment += '| Metric | Coverage | Threshold | Status |\n';
            comment += '|--------|----------|-----------|--------|\n';
            
            const thresholds = {
              'INSTRUCTION': 90.0,
              'LINE': 90.0,
              'BRANCH': 90.0,
              'METHOD': 90.0,
              'CLASS': 90.0
            };
            
            for (const [metric, threshold] of Object.entries(thresholds)) {
              if (coverage[metric]) {
                const pct = coverage[metric].percentage;
                const status = pct >= threshold ? '‚úÖ' : '‚ùå';
                comment += `| ${metric} | ${pct}% | ${threshold}% | ${status} |\n`;
              }
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: target/surefire-reports/**/*.xml
          check_name: Test Results

      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            target/site/jacoco/
            coverage-results.json
          retention-days: 30

      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: target/surefire-reports/
          retention-days: 30

      - name: Upload Jacoco XML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-xml
          path: target/site/jacoco/jacoco.xml

      - name: Publish Coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Test Summary
        if: always()
        run: |
          echo "## ‚úÖ Build & Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ‚úÖ Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Run**: Check artifacts for details" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage Report**: Uploaded to artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Create Failure Issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `‚ùå CI Pipeline Failed: ${context.workflow} #${context.runNumber}`;
            const body = `
            ## Build Failure Details
            
            **Workflow**: ${context.workflow}
            **Run**: [View Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            **Commit**: ${context.sha}
            **Branch**: ${context.ref}
            
            Please review the logs for details.
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body
            });

  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Download Coverage Results
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports

      - name: Validate Coverage Thresholds
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          
          coverage = json.load(open('coverage-results.json'))
          
          thresholds = {
              'LINE': 90.0,
              'METHOD': 90.0,
              'INSTRUCTION': 90.0
          }
          
          print("üéØ Quality Gate Check")
          print("=" * 50)
          
          all_pass = True
          for metric, threshold in thresholds.items():
              if metric in coverage:
                  actual = coverage[metric]['percentage']
                  status = "‚úÖ PASS" if actual >= threshold else "‚ùå FAIL"
                  print(f"{metric}: {actual}% (target: {threshold}%) - {status}")
                  if actual < threshold:
                      all_pass = False
          
          print("=" * 50)
          if all_pass:
              print("‚úÖ All quality gates passed!")
          else:
              print("‚ö†Ô∏è  Some quality gates failed!")
          
          exit(0 if all_pass else 1)
          PY

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [build, quality-gates]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "## üîÑ CI/CD Pipeline Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status**: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Quality Gates**: ${{ needs.quality-gates.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Artifacts Available**:" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "- Test Reports" >> $GITHUB_STEP_SUMMARY
          echo "- JaCoCo XML" >> $GITHUB_STEP_SUMMARY
